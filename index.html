<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>クロッキー（UI最小化テスト）</title>
  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#121212;
      --line:#232323;
      --fg:#f2f2f2;
      --muted:#b7b7b7;
      --accent:#4aa3ff;

      --topbar-h:56px;     /* 上バー（準備中は高め、クロッキー中は最小化） */
      --img-max:700px;     /* 画像は縦or横どちらかを700に収める */
    }

    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font:15px/1.5 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;
    }

    /* ====== 上部バー（準備中:通常 / クロッキー中:min） ====== */
    .topbar{
      position:fixed; inset:0 0 auto 0;
      height:var(--topbar-h);
      padding:calc(env(safe-area-inset-top) + 8px) 12px 8px;
      box-sizing:border-box;
      display:flex; gap:10px; align-items:center;
      background:#0f0f0f;
      border-bottom:1px solid var(--line);
      z-index:10;
      transition:height .18s ease, padding .18s ease;
    }

    /* クロッキー中＝最小化（画像＋残り時間＋☰＋停止だけ） */
    body.running .topbar{
      height:44px;
      padding:calc(env(safe-area-inset-top) + 6px) 10px 6px;
    }

    .btn{
      height:36px; padding:0 12px;
      border-radius:12px;
      border:1px solid #2a2a2a;
      background:#151515;
      color:var(--fg);
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      user-select:none;
    }
    .btn.icon{width:40px; padding:0}
    .btn.primary{background:var(--accent); border-color:transparent; color:#001a2e; font-weight:700;}
    .btn:focus-visible{outline:2px solid var(--accent); outline-offset:2px}

    /* 残り時間（数字） */
    .timebox{
      font-feature-settings:"tnum";
      display:flex; align-items:baseline; gap:6px;
      padding:6px 10px;
      border:1px solid #2a2a2a;
      background:#141414;
      border-radius:12px;
      white-space:nowrap;
    }
    .timebox strong{font-size:1.05rem}
    body.running .timebox strong{font-size:1.1rem}

    /* 準備中に見せるメニュー群（クロッキー中は隠す） */
    .menu-area{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      margin-left:auto;
    }
    body.running .menu-area{
      display:none; /* ←ここが “クロッキー中は最小UI” の核 */
    }

    /* 右側：クロッキー中も出す最低限操作 */
    .min-area{
      margin-left:auto;
      display:flex; gap:8px; align-items:center;
    }
    /* 準備中は「再生」メイン、クロッキー中は「停止」＋☰だけでもOK */
    .min-area .stopOnly{display:none;}
    body.running .min-area .stopOnly{display:inline-flex;}
    body.running .min-area .playOnly{display:none;}

    /* ====== ドロワーメニュー（☰で開く） ====== */
    .backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      z-index:19;
    }
    .backdrop.open{display:block;}
    .drawer{
      position:fixed;
      top:calc(var(--topbar-h) + env(safe-area-inset-top));
      left:0;
      width:min(360px, 92vw);
      height:calc(100% - (var(--topbar-h) + env(safe-area-inset-top)));
      background:var(--panel);
      border-right:1px solid var(--line);
      transform:translateX(-110%);
      transition:transform .18s ease;
      z-index:20;
      overflow:auto;
      padding:12px;
      box-sizing:border-box;
    }
    .drawer.open{transform:translateX(0);}
    .group{
      border:1px solid #242424;
      border-radius:14px;
      padding:10px;
      margin-bottom:10px;
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      background:#141414;
    }
    label{color:var(--muted); font-size:.9rem}
    input[type="number"]{
      height:36px; width:92px;
      border-radius:12px;
      border:1px solid #2a2a2a;
      background:#101010;
      color:var(--fg);
      padding:0 10px;
    }

    /* ====== メイン表示（画像） ====== */
    .app{
      min-height:100%;
      padding-top:calc(var(--topbar-h) + env(safe-area-inset-top));
      box-sizing:border-box;
      display:grid;
      place-items:center;
      padding-left:12px; padding-right:12px;
    }
    .stage{
      width:min(1200px, 100%);
      border:1px solid #1f1f1f;
      border-radius:16px;
      background:#000;
      overflow:hidden;
      padding:12px;
      box-sizing:border-box;
      display:grid;
      place-items:center;
      min-height:260px;
    }
    img{
      display:block;
      width:auto; height:auto;
      max-width:min(100%, var(--img-max));
      max-height:min(80vh, var(--img-max));
      object-fit:contain;
      image-orientation:from-image;
    }
    .hint{
      color:#9a9a9a;
      border:1px dashed #2a2a2a;
      border-radius:12px;
      padding:14px;
      text-align:center;
      max-width:520px;
      margin:0;
    }

    /* クロッキー中は余計な説明を減らしたい場合に備えて */
    body.running .hint{display:none;}
  </style>
</head>

<body>
  <!-- Topbar -->
  <header class="topbar" id="topbar">
    <button class="btn icon" id="menuBtn" aria-label="メニュー" aria-expanded="false">≡</button>

    <div class="timebox" aria-label="残り時間">
      <span>残り</span>
      <strong id="timeNum">60</strong>
      <span>秒</span>
    </div>

    <!-- 準備中に見せるメニュー群（クロッキー中は隠れる） -->
    <div class="menu-area" id="menuArea">
      <button class="btn" id="pickBtn">画像を選択</button>
      <label>秒数</label>
      <input id="secInput" type="number" min="5" max="600" step="5" value="60">
      <button class="btn" id="nextBtn">次へ</button>
    </div>

    <!-- 最低限（クロッキー中も表示） -->
    <div class="min-area">
      <button class="btn primary playOnly" id="playBtn">再生</button>
      <button class="btn primary stopOnly" id="stopBtn">停止</button>
    </div>
  </header>

  <!-- Drawer -->
  <div class="backdrop" id="backdrop"></div>
  <aside class="drawer" id="drawer" aria-label="設定メニュー">
    <div class="group">
      <b style="margin-right:auto;">メニュー</b>
      <button class="btn" id="closeDrawer">閉じる</button>
    </div>

    <div class="group">
      <button class="btn" id="pickBtn2">画像を選択</button>
      <span style="color:var(--muted); font-size:.85rem;" id="fileName">未選択</span>
    </div>

    <div class="group">
      <label>秒数</label>
      <input id="secInput2" type="number" min="5" max="600" step="5" value="60">
      <button class="btn" id="applySec">反映</button>
    </div>

    <div class="group">
      <button class="btn" id="nextBtn2">次へ</button>
      <button class="btn" id="resetBtn">リセット</button>
    </div>

    <p style="color:var(--muted); font-size:.85rem; margin:6px 2px 0;">
      ※ クロッキー中は「画像＋残り時間＋☰＋停止」だけが表示されます。設定変更は☰から。
    </p>
  </aside>

  <!-- Main -->
  <main class="app">
    <section class="stage" id="stage">
      <p class="hint" id="hint">
        「画像を選択」→「再生」で開始。<br>
        クロッキー中はUIが最小化されます（☰で設定を開けます）。
      </p>
      <img id="img" alt="選択した画像" hidden>
    </section>
  </main>

  <input id="fileInput" type="file" accept="image/*" hidden />

  <script>
    (() => {
      const body = document.body;

      const menuBtn = document.getElementById('menuBtn');
      const drawer = document.getElementById('drawer');
      const backdrop = document.getElementById('backdrop');
      const closeDrawer = document.getElementById('closeDrawer');

      const fileInput = document.getElementById('fileInput');
      const pickBtn = document.getElementById('pickBtn');
      const pickBtn2 = document.getElementById('pickBtn2');

      const img = document.getElementById('img');
      const hint = document.getElementById('hint');
      const fileName = document.getElementById('fileName');

      const secInput = document.getElementById('secInput');
      const secInput2 = document.getElementById('secInput2');
      const applySec = document.getElementById('applySec');

      const timeNum = document.getElementById('timeNum');

      const playBtn = document.getElementById('playBtn');
      const stopBtn = document.getElementById('stopBtn');

      const nextBtn = document.getElementById('nextBtn');
      const nextBtn2 = document.getElementById('nextBtn2');
      const resetBtn = document.getElementById('resetBtn');

      let currentUrl = null;
      let running = false;

      let totalSec = 60;
      let remain = 60;
      let timerId = null;

      // Drawer open/close
      const openDrawer = () => {
        drawer.classList.add('open');
        backdrop.classList.add('open');
        menuBtn.setAttribute('aria-expanded', 'true');
      };
      const close = () => {
        drawer.classList.remove('open');
        backdrop.classList.remove('open');
        menuBtn.setAttribute('aria-expanded', 'false');
      };

      menuBtn.addEventListener('click', () => {
        if (drawer.classList.contains('open')) close();
        else openDrawer();
      });
      backdrop.addEventListener('click', close);
      closeDrawer.addEventListener('click', close);

      // Pick image
      const pick = () => fileInput.click();
      pickBtn.addEventListener('click', pick);
      pickBtn2.addEventListener('click', pick);

      fileInput.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0];
        if (!f) return;

        if (currentUrl) URL.revokeObjectURL(currentUrl);
        currentUrl = URL.createObjectURL(f);
        img.src = currentUrl;
        img.hidden = false;
        hint.style.display = 'none';
        fileName.textContent = f.name;
      });

      // Seconds sync
      const setSeconds = (v) => {
        const n = Math.max(5, Math.min(600, Math.round(v / 5) * 5));
        totalSec = n;
        remain = n;
        timeNum.textContent = remain;
        secInput.value = n;
        secInput2.value = n;
      };
      setSeconds(60);

      secInput.addEventListener('change', () => setSeconds(Number(secInput.value)));
      applySec.addEventListener('click', () => { setSeconds(Number(secInput2.value)); close(); });

      // Running UI toggle
      const setRunning = (on) => {
        running = on;
        body.classList.toggle('running', on);
      };

      const tick = () => {
        remain -= 1;
        if (remain <= 0) {
          remain = 0;
          timeNum.textContent = remain;
          stop();
          return;
        }
        timeNum.textContent = remain;
      };

      const start = () => {
        if (!img.src) { alert('先に画像を選択してください'); return; }
        stop(); // 念のため
        remain = totalSec;
        timeNum.textContent = remain;
        setRunning(true);
        timerId = setInterval(tick, 1000);
      };

      const stop = () => {
        if (timerId) clearInterval(timerId);
        timerId = null;
        setRunning(false);
        remain = totalSec;
        timeNum.textContent = remain;
      };

      playBtn.addEventListener('click', start);
      stopBtn.addEventListener('click', stop);

      // Next: ひとまず「時間をリセットするだけ」(見た目確認用)
      const next = () => {
        remain = totalSec;
        timeNum.textContent = remain;
      };
      nextBtn.addEventListener('click', next);
      nextBtn2.addEventListener('click', () => { next(); close(); });

      resetBtn.addEventListener('click', () => {
        stop();
        setSeconds(60);
        fileInput.value = '';
        fileName.textContent = '未選択';
        if (currentUrl) URL.revokeObjectURL(currentUrl);
        currentUrl = null;
        img.hidden = true;
        img.removeAttribute('src');
        hint.style.display = '';
        close();
      });

      // Hotkeys
      window.addEventListener('keydown', (e) => {
        const tag = e.target && e.target.tagName;
        if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return;

        if (e.key === 'Escape') close();
        if (e.key === ' ') { e.preventDefault(); running ? stop() : start(); }
        if (e.key.toLowerCase() === 'm') drawer.classList.contains('open') ? close() : openDrawer();
      });

      // cleanup
      window.addEventListener('beforeunload', () => {
        if (currentUrl) URL.revokeObjectURL(currentUrl);
      });
    })();
  </script>
</body>
</html>
